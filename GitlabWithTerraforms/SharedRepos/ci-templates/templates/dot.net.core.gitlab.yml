include:
  - project: 'emobility/global-emobility/eon-drive-devops/ci-templates'
    ref: main                                      # Git branch
    file: '/templates/version-template.yml'
  - project: 'emobility/global-emobility/eon-drive-devops/ci-templates'
    ref: main                                      # Git branch
    file: '/templates/docker-publish-template.yml'
  - project: 'emobility/global-emobility/eon-drive-devops/ci-templates'
    ref: main                                      # Git branch
    file: '/templates/base-rules.yml'
  - project: 'emobility/global-emobility/eon-drive-devops/ci-templates'
    ref: main                                      # Git branch
    file: '/templates/sonarqube.yml'
  - project: 'emobility/global-emobility/eon-drive-devops/ci-templates'
    ref: main                                      # Git branch
    file: '/templates/app-container-deployment.yml'

variables:
  AZURE_APP_NAME: "your-azure-webapp-name"
  BUILD_IMAGE: "mcr.microsoft.com/dotnet/sdk:7.0"

  
stages:
  - prepare
  - build
  - test
  - publish
  - deploy to dev
  - deploy to test
  - deploy to production

cache:
  paths:
    - .m2/repository

build:
  stage: build
  image: $BUILD_IMAGE
  script:
    - dotnet tool install -g dotnet-reportgenerator-globaltool
    - dotnet test --configuration Release /p:CollectCoverage=true /p:CoverletOutputFormat=opencover
    - dotnet reportgenerator "-reports:**/coverage.opencover.xml" "-targetdir:coverage" -reporttypes:Html
  artifacts:
    paths:
      - target/site/jacoco/jacoco.xml
    expire_in: 1 week
    reports:
      coverage_report:
        coverage_format: cobertura
        path: target/site/jacoco/jacoco.xml
  rules:
    - !reference [.rules:branches_for_testing, rules]

sonarqube-check:
  stage:  test
  variables:
    EXTRA_SONAR_PROPERTIES: "-Dsonar.java.coveragePlugin=jacoco -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml -Dsonar.java.binaries=target"
  needs: 
    - job: build
      artifacts: true

build and publish image:
  needs:
    - job: calculate version number
      artifacts: true
    - job: build
      artifacts: true
    - job: sonarqube-check
  rules:
    - !reference [.rules:branches_for_image_publishing, rules]

deploy app code to dev:
  extends: .update_app_image_tag
  stage: deploy to dev
  environment:
    name: dev
  rules:
    - !reference [.rules:branches_for_dev, rules]

deploy app code to test:
  extends: .update_app_image_tag
  stage: deploy to test
  environment:
    name: test
  rules:
    - !reference [.rules:branches_for_test_env, rules]

deploy app code to production:
  extends: .update_app_image_tag
  stage: deploy to production
  environment: 
    name: production
  rules:
    - !reference [.rules:branches_for_prod_env, rules]